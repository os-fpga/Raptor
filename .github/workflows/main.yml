name: 'main'

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      Release_Date:
        description: 'Release date of Raptor in format -v YYYY.MM'
        default: ""
        type: string
      Production_Devices:
        description: 'Name of production devices separated by space'
        default: ""
        type: string
env:
    PRODUCTION_DEVICES: "1GE100-ES1"

jobs:
  linux-gcc:
    name: ubuntu-${{ matrix.mode }}

    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        mode:
        - test
        - test/batch
        - test/batch_gen2
        - regression
#        - coverage
        - install
        - valgrind
        - production
        - solver
    env:
      MODE: ${{ matrix.mode }}

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA_PD_CASTOR_RS }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        bash .github/workflows/install_ubuntu_dependencies_build.sh
#        bash .github/workflows/install_litex_ubuntu.sh

    - name: Setup Python Packages
      run: |
        pip3 install orderedmultidict
        pip3 install psutil

    - name: Use ccache
      uses: hendrikmuhs/ccache-action@v1.2.3
      with:
        key: linux-${{ matrix.mode }}

    - name: Configure shell
      run: |
        echo 'CC=gcc-11' >> $GITHUB_ENV
        echo 'CXX=g++-11' >> $GITHUB_ENV
        echo 'PATH=/usr/lib/ccache:'"$PATH" >> $GITHUB_ENV
        echo 'PREFIX=/tmp/raptor_gui-install' >> $GITHUB_ENV
        echo "$PREFIX" >> $GITHUB_PATH
        echo "ADDITIONAL_CMAKE_OPTIONS='-DMY_CXX_WARNING_FLAGS="-W -Wall -Wextra -Wno-unused-parameter -Wno-unused-variable -Werror -UNDEBUG"'" >> $GITHUB_ENV
        echo 'RULE_MESSAGES=off' >> $GITHUB_ENV
        echo 'LC_ALL=en_US.utf-8' >> $GITHUB_ENV
        echo 'LANG=en_US.utf-8' >> $GITHUB_ENV
        event_type=`echo ${{ github.event_name }}`
        if [ $event_type == 'workflow_dispatch' ]
        then
              echo 'p_devices="${{ inputs.Production_Devices }}"' >> $GITHUB_ENV
        else
              echo 'p_devices="$PRODUCTION_DEVICES"' >> $GITHUB_ENV
        fi

    - name: Show shell configuration
      run: |
        env
        which cmake && cmake --version
        which make && make --version
        which swig && swig -version
        which python && python --version
        which ninja && ninja --version
        which tclsh && echo 'puts [info patchlevel];exit 0' | tclsh
        which $CC && $CC --version
        which $CXX && $CXX --version
        echo -e "Production devices are\n\t${{ env.p_devices }}"

    - name: free disk space
      run: |
        du -sch *
        df -h
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        docker rmi $(docker image ls -aq)
        sudo apt-get autoremove -y >/dev/null 2>&1
        sudo apt-get autoclean -y >/dev/null 2>&1
        sudo rm -rf /usr/local/lib/android >/dev/null 2>&1
        df -h

    - name: Test Release
      if: matrix.mode == 'test'
      run: |
        make release ADDITIONAL_CMAKE_OPTIONS=-DBUILD_YOSYS_PLUGINS=ON test

    - name: test/batch Release
      if: matrix.mode == 'test/batch'
      run: |
        make release test/batch

    - name: test/batch_gen2 Release
      if: matrix.mode == 'test/batch_gen2'
      run: |
        make release test/batch_gen2

    - name: test/solver
      if: matrix.mode == 'solver'
      run: |
        make solver/tests 

    - name: Regression
      if: matrix.mode == 'regression'
      run: |
        make regression

    - name: Coverage
      if: matrix.mode == 'coverage'
      run: |
        make debug coverage-build/raptor_gui.coverage

    - name: Production
      if: matrix.mode == 'production'
      run: |
        make release PRODUCTION_BUILD=1 PRODUCTION_DEVICES=${{ env.p_devices }}
        ./build/bin/raptor --version
        ./build/bin/Flex_LM/lmutil lmhostid
        export LM_LICENSE_FILE=${GITHUB_WORKSPACE}/.github/bin/.raptor.lic
        ./build/bin/raptor --batch --mute --script tests/tcl_examples/and2_verilog/run_raptor.tcl 

    - name: Valgrind & Debug
      if: matrix.mode == 'valgrind'
      run: |
        make debug
        make debug test/unittest-d
        make debug test/gui
        make debug test/valgrind

    - name: Install Test
      if: matrix.mode == 'install'
      run: |
        make release ADDITIONAL_CMAKE_OPTIONS=-DBUILD_YOSYS_PLUGINS=ON
        make install
        make clean   # make sure we only see installation artifacts
        make test_install

    - name: Archive regression artifacts
      if: matrix.mode == 'test/batch_gen2' && always()
      uses: actions/upload-artifact@v3.1.0
      with:
        name: raptor_gui-linux-gcc-regression
        path: |
          ${{ github.workspace }}/build/share/raptor
          ${{ github.workspace }}/tests/

    - name: Print server resource
      if: success() || failure()
      run: |
        df -h
        du -sch *

# Reference: https://github.com/OPM/ResInsight/blob/dev/.github/workflows/centos7.yml
  centos7-gcc:
    name:  centos7-${{ matrix.mode }}
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        mode:
        - test
        - regression
        - production

    env:
      MODE: ${{ matrix.mode }}

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - name: free disk space
      run: |
        df -h
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        docker rmi $(docker image ls -aq)
        docker pull 94351b:acbdd62effef4b24a96f5748419b368b
        sudo apt-get autoremove -y >/dev/null 2>&1
        sudo apt-get autoclean -y >/dev/null 2>&1
        sudo rm -rf /usr/local/lib/android >/dev/null 2>&1
        df -h

    - name: Log in to the Container registry
      uses: docker/login-action@v3.0.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}          

    - name: pull the CentOS image
      run: docker pull ghcr.io/rapidsilicon/raptor:centos_with_docker    

    - name: Checkout code
      uses: actions/checkout@v3       
      
    - name: Checkout Subsystem
      run: |
        set +e
        make run-cmake-release ONLY_CHECKOUT_SUBSYSTEMS=ON
        echo "Done"

    - name: Show shell configuration
      uses: addnab/docker-run-action@v3
      with:
        shell: bash
        image: ghcr.io/rapidsilicon/raptor:centos_with_docker
        run: |
          cmake --version
          gcc --version         

    - name: Test
      if: matrix.mode == 'test'
      uses: addnab/docker-run-action@v3
      with:
        shell: bash
        image: ghcr.io/rapidsilicon/raptor:centos_with_docker
        options: -v ${{ github.workspace }}:/work
        run: |
            ls -l
            cd work
            ls -l
            make release test/batch

    - name: Regression
      if: matrix.mode == 'regression'
      uses: addnab/docker-run-action@v3
      with:
        shell: bash
        image: ghcr.io/rapidsilicon/raptor:centos_with_docker
        options: -v ${{ github.workspace }}:/work 
        run: |
            cd work
            ls -l
            make release ADDITIONAL_CMAKE_OPTIONS=-DBUILD_YOSYS_PLUGINS=ON test/batch
            make regression             

    - name: Production Build
      # Change ref head to deploy using a different branch.
      if: "${{ matrix.mode == 'production' && github.ref == 'refs/heads/main' }}"
      uses: addnab/docker-run-action@v3
      with:
        shell: bash
        image: ghcr.io/rapidsilicon/raptor:centos_with_docker
        options: -v ${{ github.workspace }}:/work -e PRODUCTION_DEVICES=${{ env.p_devices }}
        run: |
            echo -e "Production devices are\n\t$PRODUCTION_DEVICES"
            mkdir /opt/instl_dir


#      run: |
#        source /opt/rh/devtoolset-11/enable
#        
#        make install PRODUCTION_BUILD=1 PREFIX=/opt/instl_dir PRODUCTION_DEVICES=${{ env.p_devices }} ${{ inputs.Release_Date }}
#        export LM_LICENSE_FILE=${GITHUB_WORKSPACE}/.github/bin/.raptor.lic
#        ./build/bin/raptor --batch --mute --script tests/tcl_examples/and2_verilog/run_raptor.tcl 
#        make clean && rm -rf yosys_verific_rs u-boot-rapidsi-dev zephyr-rapidsi-dev EmbeddedCommon-dev etc tests examples FOEDAG_rs IP_Catalog Backend
#        export LD_LIBRARY_PATH=/opt/instl_dir/lib64/raptor/lib:/usr/local/Qt-5.15.4/lib:$LD_LIBRARY_PATH
#        cd $GITHUB_WORKSPACE/Raptor_Tools/Create_Raptor_Artifact && bash create_release.sh  -C -w  /opt/instl_dir 

    - name: Print server resource
      if: success() || failure()
      run: |
        df -h  

    - name: Check FTP server status
      # Change ref head to deploy using a different branch.
      if: "${{ matrix.mode == 'production' && github.ref == 'refs/heads/main' }}"
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.FTP_IP }}
        username: ${{ secrets.FTP_USER }}
        key: ${{ secrets.FTP_KEY }}
        port: ${{ secrets.FTP_PORT }}
        script: whoami
#
#    - name: Deploy
#      # Change ref head to deploy using a different branch.
#      if: "${{ matrix.mode == 'production' && github.ref == 'refs/heads/main'}}"
#      #if: "${{ matrix.mode == 'regression'}}"
#      uses: appleboy/scp-action@master
#      with:
#         host: ${{ secrets.FTP_IP }}
#         username: ${{ secrets.FTP_USER }}
#         key: ${{ secrets.FTP_KEY }}
#         port: ${{ secrets.FTP_PORT }}
#         source: "./Raptor_Tools/upload/*"
#         target: "/home/rsbuilder/Raptor"
       

# Reference: https://github.com/eyllanesc/69108420/blob/main/.github/workflows/test.yml
  msys2-gcc:
    if: ${{ false }}  # disable for now
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

# Fix Cmake version, 3.21.4 has a bug that prevents Tcl to build
    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v1.13.0
      with:
        cmake-version: '3.21.3'

    - name: Configure Git
      run: git config --global core.autocrlf input
      shell: bash

    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - name: Git pull
      uses: actions/checkout@v3

    - name: Install core dependencies
      run: choco install -y swig --side-by-side --version=3.0.12
      shell: powershell

    - name: Setup Python Packages
      run: |
        pip3 install orderedmultidict
        pip3 install psutil

    - name: Setup Msys2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MSYS
        update: true
        install:  gcc make cmake ninja python python-devel git diffutils autoconf
        release: false
      env:
        MSYS2_PATH_TYPE: inherit
    
# Install Qt
    - shell: msys2 {0}
      run: |
        pacman --noconfirm -S zlib
        pacman --noconfirm -S zlib-devel
        pacman --noconfirm -S mingw-w64-x86_64-qt5
        # Static version pacman --noconfirm -Syu mingw-w64-x86_64-qt5-static
        find . -name qt5-config.cmake
        find . -name Qt5Config.cmake
        find /mingw64 -name qt5-config.cmake
        find /mingw64 -name Qt5Config.cmake
        find C:/msys64/ -name qt5-config.cmake
        find C:/msys64/ -name Qt5Config.cmake
        
    - name: Configure shell environment variables
      run: |
        export SWIG_DIR=/c/ProgramData/chocolatey/lib/swig/tools/install/swigwin-3.0.12
        export Qt5_Dir=/mingw64/lib/cmake/Qt5/
        # Static version: export Qt5_Dir=/mingw64/qt5-static/lib/cmake/Qt5/
        export Qt5_DIR=$Qt5_Dir
        export CWD=`pwd`
        echo "Qt5_DIR=$Qt5_DIR" >> $GITHUB_ENV
        echo "SWIG_DIR=$SWIG_DIR" >> $GITHUB_ENV
        echo 'CMAKE_GENERATOR=Ninja' >> $GITHUB_ENV
        echo 'CC=gcc' >> $GITHUB_ENV
        echo 'CXX=g++' >> $GITHUB_ENV
        echo 'NO_TCMALLOC=On' >> $GITHUB_ENV
        echo "PREFIX=$CWD/install" >> $GITHUB_ENV

        echo "$Qt5_DIR" >> $GITHUB_PATH
        echo "$SWIG_DIR" >> $GITHUB_PATH

    - name: Show shell configuration
      run: |
        export PATH=$SWIG_DIR:$PATH
        env
        where git && git --version
        where cmake && cmake --version
        where make && make --version
        where swig && swig -version
        where python && python --version
        where ninja && ninja --version
        where tclsh && echo 'puts [info patchlevel];exit 0' | tclsh
        where $CC && $CC --version
        where $CXX && $CXX --version

    - name: Build
      run: |
        export PATH=$SWIG_DIR:$PATH
        export Qt5_Dir=/mingw64/lib/cmake/Qt5/
        # export Qt5_Dir=/mingw64/qt5-static/lib/cmake/Qt5/
        export Qt5_DIR=$Qt5_Dir
        export PATH=$Qt5_DIR:$PATH
        make lib-only
# There are Qt linkage issues, so build only the libs for now        
#        make VERBOSE=1 release
#        make debug 
#        make install

    - name: Test
      run: |
        export PATH=$SWIG_DIR:$PATH
        export Qt5_Dir=/mingw64/lib/cmake/Qt5/
        # export Qt5_Dir=/mingw64/qt5-static/lib/cmake/Qt5/
        export Qt5_DIR=$Qt5_Dir
        export PATH=$Qt5_DIR:$PATH
# There Qt are linkage issues, so build only the libs for now        
#        make test_install
#        make test/unittest
#        make regression

  windows-msvc:
    if: ${{ false }}  # disable for now
    runs-on: windows-2022

    defaults:
      run:
        shell: cmd

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

# Fix Cmake version, 3.21.4 has a bug that prevents Tcl to build
    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v1.13.0
      with:
        cmake-version: '3.21.3'
    - name: Use cmake
      run: cmake --version

    - name: Install Core Dependencies
      run: |
        choco install -y make
        choco install -y swig --side-by-side --version=3.0.12

    - name: Setup Python
      uses: actions/setup-python@v4.3.0
      with:
        python-version: 3.8
        architecture: x64

    - name: Setup Python Packages
      run: |
        pip3 install orderedmultidict
        pip3 install psutil

    - name: Install Qt
      uses: jurplel/install-qt-action@v3.0.0

    - run: git config --global core.autocrlf input
      shell: bash

    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - uses: actions/checkout@v3

    - name: Build & Test
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

        set CMAKE_GENERATOR=Ninja
        set CC=cl
        set CXX=cl
        set NO_TCMALLOC=On
        set PREFIX=%GITHUB_WORKSPACE%\install
        set CPU_CORES=%NUMBER_OF_PROCESSORS%

        set MAKE_DIR=C:\make\bin
        #set TCL_DIR=%PROGRAMFILES%\Git\mingw64\bin
        set SWIG_DIR=%PROGRMDATA%\chocolatey\lib\swig\tools\install\swigwin-3.0.12
        set PATH=%pythonLocation%;%SWIG_DIR%;%MAKE_DIR%;%PATH%
        #set PATH=%pythonLocation%;%SWIG_DIR%;%MAKE_DIR%;%TCL_DIR%;%PATH%

        set
        where cmake && cmake --version
        where make && make --version
        where swig && swig -version
        where python && python --version
        where ninja && ninja --version

        make release ADDITIONAL_CMAKE_OPTIONS=-DBUILD_YOSYS_PLUGINS=ON
        if %errorlevel% neq 0 exit /b %errorlevel%
        make install
        if %errorlevel% neq 0 exit /b %errorlevel%
        make test/unittest
        if %errorlevel% neq 0 exit /b %errorlevel%
        make test_install
        if %errorlevel% neq 0 exit /b %errorlevel%
        make regression
        if %errorlevel% neq 0 exit /b %errorlevel%
        make test/batch

    - name: Archive build artifacts
      uses: actions/upload-artifact@v3.1.0
      with:
        name: raptor_gui-windows-msvc
        path: ${{ github.workspace }}/install

    - name: Archive regression artifacts
      if: always()
      uses: actions/upload-artifact@v3.1.0
      with:
        name: raptor_gui-windows-msvc-regression
        path: |
          ${{ github.workspace }}/build/test/
          ${{ github.workspace }}/build/tests/

  macos-gcc:
    if: ${{ false }}  # disable till EDA-802 is fixed
    runs-on: macos-latest

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

    - uses: actions/setup-python@v4.3.0
      with:
        python-version: 3.8

    - name: Setup Python Packages
      run: |
        pip3 install orderedmultidict
        pip3 install psutil

    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - uses: actions/checkout@v3

    - name: Install dependencies
      uses: jurplel/install-qt-action@v3.0.0
      with:
        setup-python: false

    - name: Use ccache
      uses: hendrikmuhs/ccache-action@v1.2.3
      with:
        key: macos-gcc

    - name: Install other dependencies
      run: |
        bash .github/workflows/install_macos_dependencies_build.sh

    - name: Configure shell
      run: |
        echo 'CC=gcc-9' >> $GITHUB_ENV
        echo 'CXX=g++-9' >> $GITHUB_ENV
        echo "/usr/local/opt/coreutils/libexec/gnubin" >> $GITHUB_PATH
        echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
        echo "$(brew --prefix)/opt/ccache/libexec" >> $GITHUB_PATH
        echo 'PREFIX=${GITHUB_WORKSPACE}/install' >> $GITHUB_ENV
        echo "$PREFIX" >> $GITHUB_PATH

    - name: Show shell configuration
      run: |
        env
        which cmake && cmake --version
        which make && make --version
        which swig && swig -version
        which python && python --version
        which tclsh && echo 'puts [info patchlevel];exit 0' | tclsh
        which $CC && $CC --version
        which $CXX && $CXX --version
        which bison && bison --version
        which install && install --version

    - name: Build
      run: |
        make release
        make install

    - name: Unit tests
      run: |
        make test_install_mac

    - name: Regression tests
      run: |
        make regression

  macos-clang:
    if: ${{ false }}  # disable till EDA-802 is fixed
    runs-on: macos-latest

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

    - uses: actions/setup-python@v4.3.0
      with:
        python-version: 3.8

    - name: Setup Python Packages
      run: |
        pip3 install orderedmultidict
        pip3 install psutil

    - name: Install dependencies
      uses: jurplel/install-qt-action@v3.0.0
      with:
        setup-python: false
        
    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - uses: actions/checkout@v3

    - name: Use ccache
      uses: hendrikmuhs/ccache-action@v1.2.3
      with:
        key: macos-clang

    - name: Install other dependencies
      run: |
        bash .github/workflows/install_macos_dependencies_build.sh

    - name: Configure shell
      run: |
        echo 'PREFIX=${GITHUB_WORKSPACE}/install' >> $GITHUB_ENV
        echo "/usr/local/opt/coreutils/libexec/gnubin" >> $GITHUB_PATH
        echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
        echo "$(brew --prefix)/opt/ccache/libexec" >> $GITHUB_PATH
        echo "$PREFIX" >> $GITHUB_PATH

    - name: Install XQuartz on macOS
      run: brew install xquartz --cask

    - name: Show shell configuration
      run: |
        env
        which cmake && cmake --version
        which make && make --version
        which swig && swig -version
        which python && python --version
        which -a bison && bison --version
        which tclsh && echo 'puts [info patchlevel];exit 0' | tclsh

    - name: Build
      run: |
        make release
        make install

    - name: Unit tests
      run: |
        make test_install_mac
        make test/unittest
        make XVFB="" debug test/gui_mac

    - name: Regression tests
      run: |
        make regression

  CodeFormatting:
    runs-on: ubuntu-20.04

    steps:

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install Dependencies
      run: |
        sudo apt-get install clang-format
        clang-format --version

    - name: Run formatting style check
      run: ./.github/bin/run-clang-format.sh

  ClangTidy:
    runs-on: ubuntu-20.04
    if: ${{github.event_name == 'pull_request'}}

    steps:

    - name: Cancel previous
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}

    - name: ssh-agent
      uses: webfactory/ssh-agent@v0.7.0
      with: 
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY_VERIFIC_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_OPENFPGA }}
          ${{ secrets.SSH_PRIVATE_KEY_FOEDAG }}
          ${{ secrets.SSH_PRIVATE_KEY_TCL }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_VERIFIC }}
          ${{ secrets.SSH_PRIVATE_KEY_RTL_BENCH }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS }}
          ${{ secrets.SSH_PRIVATE_KEY_YOSYS_PLUGINS }}
          ${{ secrets.SSH_PRIVATE_KEY_ABC }}
          ${{ secrets.SSH_PRIVATE_KEY_LOGIC_SYNTH }}
          ${{ secrets.SSH_PRIVATE_KEY_JIRA_TESTCASE }}
          ${{ secrets.SSH_PRIVATE_KEY_LITEX_RS }}
          ${{ secrets.SSH_PRIVATE_KEY_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_RAPTOR_TOOLS }}
          ${{ secrets.SSH_PRIVATE_KEY_IP_CATALOG }}
          ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
          ${{ secrets.SSH_PRIVATE_KEY_EMBEDDED_COMMON_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_U_BOOT_DEV }}
          ${{ secrets.SSH_PRIVATE_KEY_ZEPHYR_DEV }}
          ${{ secrets.SSH_RS_FPGA_PRIMITIVES }}

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update -qq && sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt -qq -y install clang-tidy-12 \
                                g++-11 tclsh  default-jre cmake \
                                uuid-dev build-essential xorg  libhwloc-dev \
                                qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qtdeclarative5-dev xvfb \
                                libusb-1.0-0-dev pkg-config

    - name: Use ccache
      uses: hendrikmuhs/ccache-action@v1.2.3
      with:
        key: clang-tidy-codegen

    - name: Configure shell
      run: |
        echo 'PATH=/usr/lib/ccache:'"$PATH" >> $GITHUB_ENV
        echo 'RULE_MESSAGES=off' >> $GITHUB_ENV

    - name: Prepare source
      run: |
        make run-cmake-release
        ln -s build/compile_commands.json .

    - name: Run clang tidy
      run: |
        ./.github/bin/run-clang-tidy.sh
